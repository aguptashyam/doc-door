{% extends "base.html" %}
{% load app_filters %}
{% block title %}Prescriptions{% endblock %}
{% block sidebar_prescription_link %}bg-gray-700{% endblock %}

{% block body_header %}
    <i class="fas fa-prescription-bottle"></i> Prescriptions
{% endblock %}

{% block body_subheader %}
    Manage your medications and prescription details
{% endblock %}

{% block body %}
    <div class="mb-6">
        {% if user.account.role == 20 %}
            <a href="/prescription/create/" class="inline-flex items-center gap-2 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors shadow-soft">
                <i class="fas fa-plus"></i>
                <span>Add Prescription</span>
            </a>
        {% endif %}
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg text-green-700 flex items-start gap-3">
                <i class="fas fa-check-circle flex-shrink-0 mt-0.5"></i>
                <span>{{ message }}</span>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Prescriptions Table -->
    <div class="card">
        <div class="card-header">
            <h2 class="text-xl font-semibold">Your Prescriptions</h2>
        </div>
        <div class="card-body">
            {% if query %}
                <div class="overflow-x-auto">
                    <table id="prescriptionTable" class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-200 bg-gray-50">
                                <th class="px-4 py-3 text-left font-semibold text-gray-700">Doctor</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-700">Patient</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-700">Medication</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-700">Strength</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-700">Date</th>
                                <th class="px-4 py-3 text-center font-semibold text-gray-700">Refills</th>
                                <th class="px-4 py-3 text-center font-semibold text-gray-700">Status</th>
                                <th class="px-4 py-3 text-center font-semibold text-gray-700">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for prescription in query %}
                                <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                                    <td class="px-4 py-3 text-gray-900">
                                        <span class="font-medium">{{ prescription.doctor.profile }}</span>
                                    </td>
                                    <td class="px-4 py-3 text-gray-700">{{ prescription.patient.profile }}</td>
                                    <td class="px-4 py-3 text-gray-900 font-medium">{{ prescription.medication }}</td>
                                    <td class="px-4 py-3 text-gray-700">{{ prescription.strength }}</td>
                                    <td class="px-4 py-3 text-gray-700">
                                        <span class="inline-block px-2 py-1 bg-gray-100 rounded text-xs">
                                            {{ prescription.date|date:"M d, Y" }}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 text-center text-gray-900 font-medium">
                                        <span class="inline-block px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-semibold">
                                            {{ prescription.refill }}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        {% if prescription.active %}
                                            <span class="inline-flex items-center gap-1 px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">
                                                <i class="fas fa-check-circle"></i>
                                                Active
                                            </span>
                                        {% else %}
                                            <span class="inline-flex items-center gap-1 px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs font-semibold">
                                                <i class="fas fa-archive"></i>
                                                Completed
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <div class="flex items-center justify-center gap-2">
                                            {% if prescription.active and user.account.role == 20 %}
                                                <a href="/prescription/update/?pk={{ prescription.pk }}" 
                                                   class="inline-flex items-center gap-1 px-3 py-1 text-sm bg-primary-100 text-primary-700 rounded hover:bg-primary-200 transition-colors"
                                                   title="Edit prescription">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <button type="button" onclick="confirmDelete({{ prescription.pk }}, '{{ prescription.medication }}')"
                                                        class="inline-flex items-center gap-1 px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors"
                                                        title="Mark as completed">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            {% endif %}
                                            <a href="/prescription/view/?pk={{ prescription.pk }}"
                                               class="inline-flex items-center gap-1 px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors"
                                               title="View details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Instructions -->
                <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex gap-3">
                        <i class="fas fa-info-circle text-blue-600 flex-shrink-0 mt-0.5"></i>
                        <div class="text-sm text-blue-900">
                            <p class="font-semibold mb-2">Prescription Information:</p>
                            <ul class="list-disc list-inside space-y-1 text-xs">
                                <li><strong>Doctor:</strong> Healthcare provider who issued the prescription</li>
                                <li><strong>Medication:</strong> Name and type of medicine prescribed</li>
                                <li><strong>Strength:</strong> Dosage amount per dose</li>
                                <li><strong>Refills:</strong> Number of times prescription can be refilled</li>
                                <li><strong>Status:</strong> Whether prescription is currently active or completed</li>
                            </ul>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="text-center py-12">
                    <div class="inline-block p-4 bg-gray-100 rounded-full mb-4">
                        <i class="fas fa-prescription-bottle text-4xl text-gray-400"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">No Prescriptions</h3>
                    <p class="text-gray-600 mb-6">You don't have any prescriptions yet.</p>
                    {% if user.account.role == 20 %}
                        <a href="/prescription/create/" class="inline-flex items-center gap-2 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                            <i class="fas fa-plus"></i>
                            <span>Create First Prescription</span>
                        </a>
                    {% else %}
                        <p class="text-sm text-gray-500">Contact your healthcare provider to request a prescription.</p>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center" x-data="{ open: false }">
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-sm w-full mx-4">
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Mark Prescription as Completed?</h3>
            <p class="text-gray-600 mb-6">
                This will mark the prescription for <strong id="deleteModalMed"></strong> as completed. This action cannot be undone.
            </p>
            <div class="flex gap-3 justify-end">
                <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                    Cancel
                </button>
                <form id="deleteForm" method="POST" class="inline">
                    {% csrf_token %}
                    <input type="hidden" name="delete_id" id="deleteId">
                    <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                        Mark Complete
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        function confirmDelete(prescriptionId, medication) {
            document.getElementById('deleteModalMed').textContent = medication;
            document.getElementById('deleteId').value = prescriptionId;
            document.getElementById('deleteModal').classList.remove('hidden');
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
        }
        
        // Close modal when clicking outside
        document.getElementById('deleteModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDeleteModal();
            }
        });
        
        // Initialize DataTable if available
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof jQuery !== 'undefined' && jQuery.fn.DataTable) {
                jQuery('#prescriptionTable').DataTable({
                    order: [[4, 'desc']],
                    pageLength: 10,
                    responsive: true,
                    columnDefs: [
                        { orderable: false, targets: [7] }
                    ]
                });
            }
        });
    </script>
{% endblock %}